<!DOCTYPE html>
<!-- * * * * * * * * * * * The content below * * * * * * * * * * * * * -->
<div class="d-flex min-vh-100 bg-light px-4" style="font-size: 0.95rem;">
  <!-- Bloc gauche (30%) -->
  <div class="d-flex flex-column align-items-start justify-content-start pe-4"
       style="width:15%; min-width:300px; position:sticky; top:0; align-self: flex-start; z-index: 1020;">
    <div class="card shadow-lg w-100 mt-0">
      <div class="card-header bg-primary text-white text-center">
        <h2 class="mb-0">Demande de location de matériel</h2>
        <small>Pour évènementiel</small>
      </div>
      <div class="card-body">
        <!-- Formulaire en 3 étapes -->
        <form (submit)="onSubmitForm($event)">
          <!-- Étape 1 : Informations client et contact -->
          @if (step === 1) {
          <div id="step1">
            <h5 class="mb-3">1. Informations client</h5>
            <div class="mb-3">
              <label for="clientName" class="form-label">Nom du client</label>
              <input type="text" id="clientName" name="clientName" class="form-control" required [(ngModel)]="formData.clientName">
            </div>
            <div class="mb-3">
              <label for="platform" class="form-label">Plateforme de contact</label>
              <select id="platform" name="platform" class="form-select" [(ngModel)]="formData.platform" required>
                <option value="">Sélectionner</option>
                <option *ngFor="let p of platformOptions" [value]="p">{{ p }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="contactDate" class="form-label">Date de prise de contact</label>
              <input type="date" id="contactDate" name="contactDate" class="form-control" [(ngModel)]="formData.contactDate">
            </div>
            <div class="mb-3">
              <label for="comments" class="form-label">Commentaires</label>
              <textarea id="comments" name="comments" class="form-control" rows="2" [(ngModel)]="formData.comments"></textarea>
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label">Numéro de téléphone</label>
              <input type="tel" id="phone" name="phone" class="form-control" pattern="^(\+?\d{1,3}[- ]?)?\d{6,14}$" [(ngModel)]="formData.phone">
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-primary btn-lg" (click)="nextStep()">Suivant</button>
            </div>
          </div>
          }
          <!-- Étape 2 : Détails de la commande -->
          @if (step === 2) {
          <div id="step2">
            <h5 class="mb-3">2. Détails de la commande</h5>
            <div class="mb-3">
              <label for="deliveryDate" class="form-label">Date de livraison souhaitée</label>
              <input type="date" id="deliveryDate" name="deliveryDate" class="form-control" [(ngModel)]="formData.deliveryDate">
            </div>
            <div *ngFor="let item of formData.items; let i = index" class="border rounded p-3 mb-3 bg-white">
              <div class="row">
                <div class="col-12 mb-2">
                  <label class="form-label" style="font-size:0.95rem;">Article souhaité</label>
                  <select class="form-select form-select-sm" [(ngModel)]="item.article" name="article{{i}}" required>
                    <option value="">Sélectionner</option>
                    <option *ngFor="let a of articleOptions" [value]="a">{{ a }}</option>
                  </select>
                </div>
                <div class="col-12 mb-2">
                  <label class="form-label" style="font-size:0.95rem;">Prix unitaire (€)</label>
                  <input type="number" class="form-control form-control-sm" min="0" step="0.01" [(ngModel)]="item.unitPrice" name="unitPrice{{i}}">
                </div>
                <div class="col-12 mb-2">
                  <label class="form-label" style="font-size:0.95rem;">Quantité</label>
                  <input type="number" class="form-control form-control-sm" min="1" required [(ngModel)]="item.quantity" name="quantity{{i}}">
                </div>
                <!-- Champ caution déplacé ici -->
                <div class="col-12 mb-2">
                  <label class="form-label" style="font-size:0.95rem;">Caution (€)</label>
                  <input type="number" class="form-control form-control-sm" min="0" step="0.01" [(ngModel)]="item.deposit" name="deposit{{i}}">
                </div>
                <div class="col-12 d-flex justify-content-end">
                  <button *ngIf="formData.items.length > 1" type="button" class="btn btn-outline-danger btn-sm" (click)="removeItem(i)" title="Supprimer cet article">
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="mb-3">
              <button type="button" class="btn btn-outline-primary" (click)="addItem()">
                Ajouter un article
              </button>
            </div>
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" (click)="prevStep()">Précédent</button>
              <button type="button" class="btn btn-primary" (click)="nextStep()">Suivant</button>
            </div>
          </div>
          }
          <!-- Étape 3 : Paiement, retour et caution -->
          @if (step === 3) {
          <div id="step3">
            <h5 class="mb-3">3. Paiement et retour</h5>
            <!-- Bouton Précédent en haut à gauche, plus petit -->
            <div class="mb-2">
              <button type="button" class="btn btn-secondary btn-sm" style="font-size:0.95rem;" (click)="prevStep()">Précédent</button>
            </div>
            <div class="mb-3">
              <label for="advance" class="form-label">Avance perçue (€)</label>
              <input type="number" id="advance" name="advance" class="form-control" min="0" step="0.01" [(ngModel)]="formData.advance" placeholder="Ex: 50">
            </div>
            <div class="mb-3">
              <label for="shippingFee" class="form-label">Frais de livraison/retour (€)</label>
              <input type="number" id="shippingFee" name="shippingFee" class="form-control" min="0" step="0.01" [(ngModel)]="formData.shippingFee">
            </div>
            <div class="mb-3">
              <label for="returnStatus" class="form-label">Retour effectué</label>
              <select id="returnStatus" name="returnStatus" class="form-select" [(ngModel)]="formData.returnStatus">
                <option value="">Sélectionner</option>
                <option value="oui">Oui</option>
                <option value="non">Non</option>
              </select>
            </div>
            <!-- Champ caution supprimé d'ici -->
            <!-- <div class="mb-3">
              <label for="deposit" class="form-label">Montant de la caution (€)</label>
              <input type="number" id="deposit" name="deposit" class="form-control" min="0" step="0.01" [(ngModel)]="formData.deposit">
            </div> -->
            <!-- Boutons Enregistrer et Mettre à jour, centrés et police réduite -->
            <div class="d-flex justify-content-center gap-2 mt-3">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="isSubmitting" style="font-size:1rem;">
                @if (isSubmitting) {
                  <output class="spinner-border spinner-border-sm me-2" aria-hidden="true"></output>
                }
                {{ isSubmitting ? 'Enregistrement...' : 'Enregistrer la demande' }}
              </button>
              <button *ngIf="selectedDemande" class="btn btn-warning btn-lg" type="button" (click)="updateSelectedDemande()" style="font-size:1rem;">
                Mettre à jour
              </button>
            </div>
            <!-- Message de feedback -->
            @if (submitMessage) {
              <div class="mt-3 alert" 
                   [class.alert-success]="submitMessage.includes('succès')" 
                   [class.alert-danger]="!submitMessage.includes('succès')">
                {{ submitMessage }}
              </div>
            }
          </div>
          }
        </form>
      </div>
    </div>
  </div>
  <!-- Barre verticale de séparation -->
  <div class="border-end border-2 mx-2" style="height:100vh;"></div>
  <!-- Bloc droit (70%) -->
  <div class="ps-4" style="width:85%;">
    <!-- Onglets dashboard -->
    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist"
        style="position:sticky; top:0; background:#f8f9fa; z-index:1030;">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'exploitation'"
          [class.btn]="activeTab === 'exploitation'"
          [class.btn-primary]="activeTab === 'exploitation'"
          id="exploitation-tab"
          (click)="activeTab = 'exploitation'"
          data-bs-toggle="tab"
          data-bs-target="#exploitation"
          type="button"
          role="tab"
          aria-controls="exploitation"
          [attr.aria-selected]="activeTab === 'exploitation'">
          Exploitation
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'dashboard'"
          [class.btn]="activeTab === 'dashboard'"
          [class.btn-primary]="activeTab === 'dashboard'"
          id="dashboard-tab"
          (click)="activeTab = 'dashboard'"
          data-bs-toggle="tab"
          data-bs-target="#dashboard"
          type="button"
          role="tab"
          aria-controls="dashboard"
          [attr.aria-selected]="activeTab === 'dashboard'">
          Dashboard
        </button>
      </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
      <!-- Onglet EXPLOITATION -->
      <div class="tab-pane fade"
           [class.show]="activeTab === 'exploitation'"
           [class.active]="activeTab === 'exploitation'"
           id="exploitation"
           role="tabpanel"
           aria-labelledby="exploitation-tab">
        <div class="container-fluid py-3">
          <h4 class="mb-4 text-primary">Toutes les demandes enregistrées</h4>
          <!-- Pagination info -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              Page {{ currentPage }} sur {{ totalPages }} 
              ({{ paginatedDemandes.length }} affichées sur {{ allDemandes.length }})
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm me-1"
                      (click)="prevPage()"
                      [disabled]="currentPage === 1">
                Précédent
              </button>
              <button class="btn btn-outline-primary btn-sm"
                      (click)="nextPage()"
                      [disabled]="currentPage === totalPages">
                Suivant
              </button>
            </div>
          </div>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>Date de livraison</th>
                <th>Client</th>
                <th>Plateforme</th>
                <th>Téléphone</th>
                <th>Avance percue (€)</th>
                <th>Montant total (€)</th>
                <!-- <th>Statut retour</th> -->
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let demande of paginatedDemandes"
                  [class.table-primary]="isDeliverySoon(demande.deliveryDate)"
                  [class.table-active]="selectedDemande && selectedDemande.id === demande.id"
                  [ngStyle]="selectedDemande && selectedDemande.id === demande.id ? {'background-color': '#ffcc00', 'border-left': '5px solid #ffcc00'} : {}"
                  style="cursor:pointer"
                  (click)="onSelectDemande(demande)">
                <td>{{ demande.deliveryDate | date:'yyyy-MM-dd' }}</td>
                <td>{{ demande.clientName }}</td>
                <td>{{ demande.platform }}</td>
                <td>{{ demande.phone }}</td>
                <td>{{ demande.advance }} €</td>
                <td>
                    {{ getTotalAmount(demande) || '0' }} €
                </td>               
              </tr>
              <tr *ngIf="paginatedDemandes.length === 0">
                <td colspan="8" class="text-center text-muted">Aucune demande enregistrée</td>
              </tr>
            </tbody>
          </table>

        </div>
        
        <!-- Section détail exhaustif de la demande sélectionnée -->
        @if (selectedDemande) {
          <hr>
          <div class="container-fluid py-3">
            <h5 class="mb-3 text-secondary">Détail de la demande sélectionnée</h5>
            <div class="row mb-2">
              <div class="col-md-4"><strong>Nom du client :</strong> {{ selectedDemande.clientName }}</div>
              <div class="col-md-4"><strong>Téléphone :</strong> {{ selectedDemande.phone }}</div>
              <div class="col-md-4"><strong>Plateforme :</strong> {{ selectedDemande.platform }}</div>
            </div>
            <div class="row mb-2">
              <div class="col-md-4"><strong>Date de contact :</strong> {{ selectedDemande.contactDate | date:'yyyy-MM-dd' }}</div>
              <div class="col-md-4"><strong>Date de livraison :</strong> {{ selectedDemande.deliveryDate | date:'yyyy-MM-dd' }}</div>
              <div class="col-md-4"><strong>Caution :</strong> {{ selectedDemande.deposit }} €</div>
            </div>
            <div class="row mb-2">
              <div class="col-md-4">
                <strong>Montant total de la commande :</strong>
                {{ getTotalAmount(selectedDemande) }} €
              </div>
              <div class="col-md-4"><strong>Avance perçue :</strong> {{ selectedDemande.advance }} €</div>
              <div class="col-md-4"><strong>Reste à régler :</strong> {{ getReste(selectedDemande) }} €</div>
            </div>
            <div class="row mb-2">
              <div class="col-md-4"><strong>Frais de livraison/retour :</strong> {{ selectedDemande.shippingFee }} €</div>
              <div class="col-md-4"><strong>Retour effectué : </strong>
                <span *ngIf="selectedDemande.returnStatus === 'oui'" class="badge bg-success"> Oui </span>
                <span *ngIf="selectedDemande.returnStatus === 'non'" class="badge bg-danger"> Non </span>
                <span *ngIf="!selectedDemande.returnStatus" class="badge bg-secondary">-</span>
              </div>
            </div>
            <div class="mb-2">
              <strong>Articles commandés :</strong>
              <table class="table table-sm table-bordered mt-2">
                <thead>
                  <tr>
                    <th>Article</th>
                    <th>Prix unitaire (€)</th>
                    <th>Quantité</th>
                    <th>Total (€)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of selectedDemande.items">
                    <td>{{ item.article }}</td>
                    <td>{{ item.unitPrice }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>{{ (item.unitPrice * item.quantity) + (item.fireFee || 0) + (item.shippingFee || 0) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="col-md-6"><strong>Commentaires :</strong> {{ selectedDemande.comments }}</div>
          </div>

          <!-- Ajout d'un espace vertical supplémentaire -->
          <div style="height: 0.75rem;"></div>

          <!-- Actions pour la ligne sélectionnée -->
          <div *ngIf="selectedDemande" class="mb-3 d-flex gap-2 align-items-center">
            <span class="fw-bold text-primary">Action sur la sélection :</span>
            <button class="btn btn-danger btn-sm" (click)="deleteSelectedDemande()" type="button">
              Supprimer
            </button>
            <!-- Le bouton "Mettre à jour" a été déplacé à côté du bouton "Enregistrer la demande" dans le formulaire -->
            <button class="btn btn-secondary btn-sm" (click)="selectedDemande = null" type="button">
              Annuler
            </button>
            <!-- Nouveau bouton Message récapitulatif -->
            <button class="btn btn-info btn-sm" type="button" (click)="showRecap = true">
              Message récapitulatif
            </button>
          </div>
          <!-- Fenêtre modale simple pour le message récapitulatif -->
          <div *ngIf="showRecap" class="modal d-block" tabindex="-1" style="background:rgba(0,0,0,0.2);">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header py-2">
                  <h6 class="modal-title">Message récapitulatif pour le client</h6>
                  <button type="button" class="btn-close" (click)="showRecap = false"></button>
                </div>

                <div class="modal-body">
                  <textarea class="form-control" rows="10" readonly>{{ getRecapMessage(selectedDemande) }}</textarea>
                </div>

                <div class="modal-footer py-2">
                  <button type="button" class="btn btn-secondary btn-sm" (click)="showRecap = false">Fermer</button>
                </div>
              </div>
            </div>
          </div>
        }
      </div>


      <!-- Nouvel onglet DASHBOARD -->
      <div class="tab-pane fade"
           [class.show]="activeTab === 'dashboard'"
           [class.active]="activeTab === 'dashboard'"
           id="dashboard"
           role="tabpanel"
           aria-labelledby="dashboard-tab">
        <div class="container-fluid py-3">
          <h4 class="mb-4 text-primary">Dashboard</h4>
          <!-- Ajoute ici le contenu du dashboard -->
          <div class="alert alert-info">Contenu du dashboard à compléter.</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- * * * * * * * * * * * The content above * * * * * * * * * * * * * -->
