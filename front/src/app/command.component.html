<!DOCTYPE html>
<!-- * * * * * * * * * * * The content below * * * * * * * * * * * * * -->
<div class="d-flex min-vh-100 bg-light px-4">
  <!-- Bloc gauche (30%) -->
  <div class="d-flex flex-column align-items-start justify-content-start pe-4" style="width:15%; min-width:300px;">
    <div class="card shadow-lg w-100 mt-0">
      <div class="card-header bg-primary text-white text-center">
        <h2 class="mb-0">Demande de location de matériel</h2>
        <small>Pour évènementiel</small>
      </div>
      <div class="card-body">
        <!-- Formulaire en 3 étapes -->
        <form (submit)="onSubmitForm($event)">
          <!-- Étape 1 : Informations client et contact -->
          @if (step === 1) {
          <div id="step1">
            <h5 class="mb-3">1. Informations client</h5>
            <div class="mb-3">
              <label for="clientName" class="form-label">Nom du client</label>
              <input type="text" id="clientName" name="clientName" class="form-control" required [(ngModel)]="formData.clientName">
            </div>
            <div class="mb-3">
              <label for="platform" class="form-label">Plateforme de contact</label>
              <select id="platform" name="platform" class="form-select" [(ngModel)]="formData.platform" required>
                <option value="">Sélectionner</option>
                <option *ngFor="let p of platformOptions" [value]="p">{{ p }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="contactDate" class="form-label">Date de prise de contact</label>
              <input type="date" id="contactDate" name="contactDate" class="form-control" [(ngModel)]="formData.contactDate">
            </div>
            <div class="mb-3">
              <label for="comments" class="form-label">Commentaires</label>
              <textarea id="comments" name="comments" class="form-control" rows="2" [(ngModel)]="formData.comments"></textarea>
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label">Numéro de téléphone</label>
              <input type="tel" id="phone" name="phone" class="form-control" pattern="^(\+?\d{1,3}[- ]?)?\d{6,14}$" [(ngModel)]="formData.phone">
            </div>
            <div class="d-grid">
              <button type="button" class="btn btn-primary btn-lg" (click)="nextStep()">Suivant</button>
            </div>
          </div>
          }
          <!-- Étape 2 : Détails de la commande -->
          @if (step === 2) {
          <div id="step2">
            <h5 class="mb-3">2. Détails de la commande</h5>
            <div class="mb-3">
              <label for="article" class="form-label">Article souhaité</label>
              <select id="article" name="article" class="form-select" [(ngModel)]="formData.article" required>
                <option value="">Sélectionner</option>
                <option *ngFor="let a of articleOptions" [value]="a">{{ a }}</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="unitPrice" class="form-label">Prix unitaire (€)</label>
              <input type="number" id="unitPrice" name="unitPrice" class="form-control" min="0" step="0.01" [(ngModel)]="formData.unitPrice">
            </div>
            <div class="mb-3">
              <label for="quantity" class="form-label">Quantité</label>
              <input type="number" id="quantity" name="quantity" class="form-control" min="1" required [(ngModel)]="formData.quantity">
            </div>
            <div class="mb-3">
              <label for="fireFee" class="form-label">Frais de feu (€)</label>
              <input type="number" id="fireFee" name="fireFee" class="form-control" min="0" step="0.01" [(ngModel)]="formData.fireFee">
            </div>
            <div class="mb-3">
              <label for="shippingFee" class="form-label">Frais de livraison/retour (€)</label>
              <input type="number" id="shippingFee" name="shippingFee" class="form-control" min="0" step="0.01" [(ngModel)]="formData.shippingFee">
            </div>
            <div class="mb-3">
              <label for="deliveryDate" class="form-label">Date de livraison souhaitée</label>
              <input type="date" id="deliveryDate" name="deliveryDate" class="form-control" [(ngModel)]="formData.deliveryDate">
            </div>
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-secondary" (click)="prevStep()">Précédent</button>
              <button type="button" class="btn btn-primary" (click)="nextStep()">Suivant</button>
            </div>
          </div>
          }
          <!-- Étape 3 : Paiement, retour et caution -->
          @if (step === 3) {
          <div id="step3">
            <h5 class="mb-3">3. Paiement et retour</h5>
            <!-- Bouton Précédent en haut à gauche, plus petit -->
            <div class="mb-2">
              <button type="button" class="btn btn-secondary btn-sm" style="font-size:0.95rem;" (click)="prevStep()">Précédent</button>
            </div>
            <div class="mb-3">
              <label for="advance" class="form-label">Avance perçue (€)</label>
              <input type="number" id="advance" name="advance" class="form-control" min="0" step="0.01" [(ngModel)]="formData.advance" placeholder="Ex: 50">
            </div>
            <div class="mb-3">
              <label for="returnStatus" class="form-label">Retour effectué</label>
              <select id="returnStatus" name="returnStatus" class="form-select" [(ngModel)]="formData.returnStatus">
                <option value="">Sélectionner</option>
                <option value="oui">Oui</option>
                <option value="non">Non</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="deposit" class="form-label">Montant de la caution (€)</label>
              <input type="number" id="deposit" name="deposit" class="form-control" min="0" step="0.01" [(ngModel)]="formData.deposit">
            </div>
            <!-- Boutons Enregistrer et Mettre à jour, centrés et police réduite -->
            <div class="d-flex justify-content-center gap-2 mt-3">
              <button type="submit" class="btn btn-primary btn-lg" [disabled]="isSubmitting" style="font-size:1rem;">
                @if (isSubmitting) {
                  <output class="spinner-border spinner-border-sm me-2" aria-hidden="true"></output>
                }
                {{ isSubmitting ? 'Enregistrement...' : 'Enregistrer la demande' }}
              </button>
              <button *ngIf="selectedDemande" class="btn btn-warning btn-lg" type="button" (click)="updateSelectedDemande()" style="font-size:1rem;">
                Mettre à jour
              </button>
            </div>
            <!-- Message de feedback -->
            @if (submitMessage) {
              <div class="mt-3 alert" 
                   [class.alert-success]="submitMessage.includes('succès')" 
                   [class.alert-danger]="!submitMessage.includes('succès')">
                {{ submitMessage }}
              </div>
            }
          </div>
          }
        </form>
      </div>
    </div>
  </div>
  <!-- Barre verticale de séparation -->
  <div class="border-end border-2 mx-2" style="height:100vh;"></div>
  <!-- Bloc droit (70%) -->
  <div class="ps-4" style="width:85%;">
    <!-- Onglets dashboard -->
    <ul class="nav nav-tabs mb-3" id="dashboardTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'exploitation'"
          [class.btn]="activeTab === 'exploitation'"
          [class.btn-primary]="activeTab === 'exploitation'"
          id="exploitation-tab"
          (click)="activeTab = 'exploitation'"
          data-bs-toggle="tab"
          data-bs-target="#exploitation"
          type="button"
          role="tab"
          aria-controls="exploitation"
          [attr.aria-selected]="activeTab === 'exploitation'">
          Exploitation
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="activeTab === 'dashboard'"
          [class.btn]="activeTab === 'dashboard'"
          [class.btn-primary]="activeTab === 'dashboard'"
          id="dashboard-tab"
          (click)="activeTab = 'dashboard'"
          data-bs-toggle="tab"
          data-bs-target="#dashboard"
          type="button"
          role="tab"
          aria-controls="dashboard"
          [attr.aria-selected]="activeTab === 'dashboard'">
          Dashboard
        </button>
      </li>
    </ul>

    <div class="tab-content" id="dashboardTabsContent">
      <!-- Onglet EXPLOITATION -->
      <div class="tab-pane fade"
           [class.show]="activeTab === 'exploitation'"
           [class.active]="activeTab === 'exploitation'"
           id="exploitation"
           role="tabpanel"
           aria-labelledby="exploitation-tab">
        <div class="container-fluid py-3">
          <h4 class="mb-4 text-primary">Toutes les demandes enregistrées</h4>
          <!-- Pagination info -->
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              Page {{ currentPage }} sur {{ totalPages }} 
              ({{ paginatedDemandes.length }} affichées sur {{ allDemandes.length }})
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm me-1"
                      (click)="prevPage()"
                      [disabled]="currentPage === 1">
                Précédent
              </button>
              <button class="btn btn-outline-primary btn-sm"
                      (click)="nextPage()"
                      [disabled]="currentPage === totalPages">
                Suivant
              </button>
            </div>
          </div>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th>Date de livraison</th>
                <th>Client</th>
                <th>Plateforme</th>
                <th>Téléphone</th>
                <th>Article</th>
                <th>Prix unitaire (€)</th>
                <th>Quantité</th>
                <th>Montant (€)</th>
                <!-- <th>Statut retour</th> -->
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let demande of paginatedDemandes"
                  [class.table-primary]="isDeliverySoon(demande.deliveryDate)"
                  [class.table-active]="selectedDemande && selectedDemande.id === demande.id"
                  [ngStyle]="selectedDemande && selectedDemande.id === demande.id ? {'background-color': '#ffcc00', 'border-left': '5px solid #ffcc00', 'border-bottom': '1px solid #ffcc00'} : {}"
                  style="cursor:pointer"
                  (click)="onSelectDemande(demande)">
                <td>{{ demande.deliveryDate | date:'yyyy-MM-dd' }}</td>
                <td>{{ demande.clientName }}</td>
                <td>{{ demande.platform }}</td>
                <td>{{ demande.phone }}</td>
                <td>{{ demande.article }}</td>
                <td>{{ demande.unitPrice }}</td>
                <td>{{ demande.quantity }}</td> 
                <td>{{ demande.totalAmount || demande.unitPrice }}</td>
                <!-- <td>
                  <span *ngIf="demande.returnStatus === 'oui'" class="badge bg-success">Oui</span>
                  <span *ngIf="demande.returnStatus === 'non'" class="badge bg-danger">Non</span>
                  <span *ngIf="!demande.returnStatus" class="badge bg-secondary">-</span>
                </td> -->
              </tr>
              <tr *ngIf="paginatedDemandes.length === 0">
                <td colspan="8" class="text-center text-muted">Aucune demande enregistrée</td>
              </tr>
            </tbody>
          </table>
          <!-- Actions pour la ligne sélectionnée -->
          <div *ngIf="selectedDemande" class="mb-3 d-flex gap-2 align-items-center">
            <span class="fw-bold text-primary">Action sur la sélection :</span>
            <button class="btn btn-danger btn-sm" (click)="deleteSelectedDemande()" type="button">
              Supprimer
            </button>
            <!-- Le bouton "Mettre à jour" a été déplacé à côté du bouton "Enregistrer la demande" dans le formulaire -->
            <button class="btn btn-secondary btn-sm" (click)="selectedDemande = null" type="button">
              Annuler
            </button>
          </div>
        </div>
      </div>
      <!-- Nouvel onglet DASHBOARD -->
      <div class="tab-pane fade"
           [class.show]="activeTab === 'dashboard'"
           [class.active]="activeTab === 'dashboard'"
           id="dashboard"
           role="tabpanel"
           aria-labelledby="dashboard-tab">
        <div class="container-fluid py-3">
          <h4 class="mb-4 text-primary">Dashboard</h4>
          <!-- Ajoute ici le contenu du dashboard -->
          <div class="alert alert-info">Contenu du dashboard à compléter.</div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- * * * * * * * * * * * The content above * * * * * * * * * * * * * -->
